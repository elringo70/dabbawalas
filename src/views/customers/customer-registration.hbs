{{>sidebar}}
<div class="admin-container">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-md-12 fw-bold fs-3">Clientes</div>
        </div>

        <div class="row mt-3 mx-auto">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        Almacenar un nuevo cliente
                    </div>
                    <div class="card-body">
                        <form id="form" autocomplete="off">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="phone">Número telefónico</label>
                                    <input type="number" name="phone" class="form-control input-number-validation"
                                        id="phone" placeholder="Número telefónico" min="1111111111" max="9999999999"
                                        pattern="[0-9]" value="{{customer.phone}}" autocomplete="new-number" required>
                                    <div id="emailHelp" class="form-text">Ingrese el número telefónico de 10 dígitos
                                    </div>
                                    <small class="text-danger" id="text-muted" hidden>Solo puede ingresar
                                        números</small>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm">
                                    <div id="phoneExistsAlert"></div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="name" class="form-label">Nombre(s)</label>
                                    <input type="text" name="name" class="form-control input-text-validation" id="name"
                                        placeholder="Nombre del cliente" value="{{customer.name}}" autocomplete="new-text"
                                        required>
                                    <small class="text-danger" id="text-muted"></small>
                                </div>
                                <div class="col-md-4">
                                    <label for="lastname" class="form-label">Apellido</label>
                                    <input type="text" name="lastname" class="form-control input-text-validation"
                                        id="lastname" placeholder="Apellido" value="{{customer.lastname}}"
                                        autocomplete="new-lastaname" required>
                                    <small class="text-danger" id="text-muted"></small>
                                </div>
                                <div class="col-md-4">
                                    <label for="maternalsurname" class="form-label">Segundo apellido</label>
                                    <input type="text" name="maternalsurname" class="form-control input-text-validation"
                                        id="maternalsurname" placeholder="Segundo apellido"
                                        value="{{customer.maternalsurname}}" autocomplete="new-maternalsurname" required>
                                    <small class="text-danger" id="text-muted"></small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-8 m-auto">
                                    <div id="dateAlert"></div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-sm-4">
                                    <label for="state">Estado</label>
                                    <select name="state" class="form-select" id="state-select" required>
                                        <option selected>Seleccione un estado</option>
                                    </select>
                                </div>
                                <div class="col-sm-4">
                                    <label for="city">Ciudad</label>
                                    <select name="city" class="form-select" id="city-select" required>
                                        <option selected>Seleccione una ciudad</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label for="municipality">Colonia</label>
                                    <select name="municipality" class="form-select" id="municipality-select" required>
                                        <option selected>Seleccione una colonia</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label for="street">Calle</label>
                                    <input type="text" name="street" class="form-control" id="street"
                                        placeholder="Calle" autocomplete="new-text"
                                        required>
                                    <small class="text-danger" id="text-muted"></small>
                                </div>
                                <div class="col-md-2">
                                    <label for="number">Número</label>
                                    <input type="number" name="number" class="form-control input-number-validation"
                                        id="number" min="1" max="99999" placeholder="Número" value="{{customer.number}}"
                                        autocomplete="new-number" required>
                                    <small class="text-danger" id="text-muted"></small>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-1">
                                    <label class="form-check-label">Género</label>
                                </div>
                                <div class="col">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gender" id="genderInput1"
                                            value="1" required>
                                        <label class="form-check-label" for="genderInput1">Hombre</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gender" id="genderInput2"
                                            value="0">
                                        <label class="form-check-label" for="genderInput2">Mujer</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gender" id="genderInput3"
                                            value="null">
                                        <label class="form-check-label" for="genderInput3">Prefiere no contestar</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-8 m-auto">
                                    <div id="formAlert"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="d-grid gap-2 col-6 mx-auto">
                                    <input type="submit" class="btn btn-primary" value="Registrar" role="button">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/addresses.js"></script>
<script>
    //Listeners

    document.getElementById('phone').addEventListener('change', findCustomerByPhone)

    //Remove more than 10 characters
    document.getElementById('phone').addEventListener('keyup', function (e) {
        if (event.target.value.length > 4) {
            event.target.value = event.target.value.slice(0, 10);
        }
    })

    document.getElementById('form').addEventListener('submit', formValidation)

    //Functions
    async function formValidation(e) {
        e.preventDefault()

        const findPhone = await findCustomerByPhone(e)

        if (findPhone) {
            const confirmation = window.confirm('¿Desea continuar con el registro?')

            if (confirmation) {
                const path = `/api/customers/postNewCustomer`
                const formData = new URLSearchParams();

                for (const pair of new FormData(form)) {
                    formData.append(pair[0], pair[1]);
                }

                try {
                    if (confirmation) {
                        const response = await fetch(path, {
                            method: 'POST',
                            body: formData
                        })

                        const data = await response.json()

                        if (data.status === 304) {
                            return sendInputAlert(data.errorMessage, 'alert-danger', 'formAlert')
                        }

                        if (data.status === 201) {
                            alert('Cliente guardado con éxito')
                            form.reset()
                        }
                    }
                } catch (error) {
                    console.log(error)
                }
            }
        }
    }

    async function findCustomerByPhone() {
        const path = `/api/customers/getCustomerByPhone`

        const customerPhone = {
            phone: document.getElementById('phone').value
        }

        try {
            const data = await fetch(path, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customerPhone)
            })

            const response = await data.json()

            if (response.status === 304) {
                sendInputAlert(response.message, 'alert-danger', 'phoneExistsAlert')
                return false
            }
            return true
        } catch (error) {
            console.log(error)
            window.alert(error)
        }
    }

</script>